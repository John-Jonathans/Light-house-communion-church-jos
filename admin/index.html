<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Connection Tester</title>
    <style>
      body { font-family: sans-serif; padding: 20px; background: #111; color: white; }
      .box { border: 1px solid #333; padding: 20px; border-radius: 10px; margin-top: 20px; background: #222; }
      h2 { margin-top: 0; color: #4ade80; }
      .error { color: #f87171; }
      pre { background: black; padding: 10px; overflow-x: scroll; border: 1px solid #444; }
      button { padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 5px; font-size: 16px; margin-top: 10px; cursor: pointer; }
    </style>
  </head>
  <body>
    <h1>üõ†Ô∏è Connection Tester</h1>
    <p>We have the key. Now let's test the door.</p>

    <div id="step1" class="box">
      <h3>Step 1: Check Key</h3>
      <div id="key-status">Waiting...</div>
    </div>

    <div id="step2" class="box" style="display:none;">
      <h3>Step 2: Test Repository</h3>
      <p>Target Repo: <strong id="repo-target">Loading...</strong></p>
      <button onclick="testConnection()">‚ö° Test Connection to GitHub</button>
      <div id="connection-result"></div>
    </div>

    <script>
      // 1. READ CONFIG TO FIND REPO NAME
      let repoName = "John-Jonathans/Light-house-communion-church-jos"; // Default fallback
      
      fetch('config.yml')
        .then(r => r.text())
        .then(text => {
          const match = text.match(/repo:\s*(.*)/);
          if (match) {
             repoName = match[1].trim();
             document.getElementById('repo-target').innerText = repoName;
          }
        });

      // 2. GET TOKEN
      function getJsonFromUrl(msg) {
        try { return JSON.parse(msg.split("success:")[1]); } catch (e) { return null; }
      }

      const rawMsg = localStorage.getItem("cms_auth_token");
      let token = "";

      if (rawMsg) {
        const data = getJsonFromUrl(rawMsg);
        if (data && data.token) {
          token = data.token;
          document.getElementById('key-status').innerHTML = "<span style='color:#4ade80'>‚úÖ Valid Key Found in Storage!</span>";
          document.getElementById('step2').style.display = 'block';
        } else {
          document.getElementById('key-status').innerHTML = "<span class='error'>‚ùå Key format is wrong. Please Login again.</span>";
        }
      } else {
        document.getElementById('key-status').innerHTML = "<span class='error'>‚ö†Ô∏è No Key Found. Please click 'Login with GitHub' first.</span>";
      }

      // 3. TEST GITHUB API
      async function testConnection() {
        const resDiv = document.getElementById('connection-result');
        resDiv.innerHTML = "Contacting GitHub...";
        
        try {
          // Verify if the token works for the user
          const userReq = await fetch('https://api.github.com/user', {
             headers: { Authorization: `Bearer ${token}` }
          });
          const userData = await userReq.json();
          
          if (!userReq.ok) {
            resDiv.innerHTML = `<p class="error">‚ùå Token Rejected: ${userData.message}</p>`;
            return;
          }
          
          resDiv.innerHTML = `<p style="color:#4ade80">‚úÖ Token is Good! (Logged in as: ${userData.login})</p>`;
          resDiv.innerHTML += "Checking Repository access...";

          // Verify if the repo exists
          const repoReq = await fetch(`https://api.github.com/repos/${repoName}`, {
             headers: { Authorization: `Bearer ${token}` }
          });
          
          if (repoReq.status === 404) {
             resDiv.innerHTML += `<p class="error">‚ùå <strong>REPO NOT FOUND!</strong><br>GitHub says "${repoName}" does not exist.<br>Check your spelling in config.yml!</p>`;
          } else if (repoReq.ok) {
             resDiv.innerHTML += `<p style="color:#4ade80">‚úÖ <strong>REPO FOUND!</strong><br>Everything is perfect.</p>`;
             resDiv.innerHTML += `<button onclick="launchCMS()">üöÄ Launch CMS Now</button>`;
          } else {
             resDiv.innerHTML += `<p class="error">‚ùå Error: ${repoReq.statusText}</p>`;
          }

        } catch (err) {
          resDiv.innerHTML = "Network Error: " + err.message;
        }
      }

      function launchCMS() {
        // If test passed, inject user and reload
        const user = { "token": token, "backendName": "github", "name": "admin" };
        localStorage.setItem("netlify-cms-user", JSON.stringify(user));
        
        // Restore the original CMS code
        document.body.innerHTML = "<h1 style='color:black;background:white;'>Reloading into Dashboard...</h1>";
        // We reload to a special parameter to trigger a "clean" load next time, 
        // but for now, you would need to revert the index.html file to the CMS version.
        // This is just a test tool.
        alert("Test Passed! Now we know the repo name is correct. You can revert index.html to the CMS version.");
      }
    </script>
  </body>
</html>

