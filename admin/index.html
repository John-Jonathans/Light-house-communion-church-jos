<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel</title>
    <style>
      body { font-family: sans-serif; text-align: center; padding: 20px; }
      #status { margin-top: 50px; padding: 20px; background: #f0fdf4; border: 1px solid #166534; color: #166534; display: none; }
    </style>
  </head>
  <body>
    <div id="status">
        <h2>âœ… Access Key Found</h2>
        <p>Injecting directly into CMS storage...</p>
        <p>Please wait for reload.</p>
    </div>

    <script>
      // Function to parse the raw message string
      function getJsonFromUrl(msg) {
        try {
          // The message looks like: authorization:github:success:{"token":"..."}
          // We need to extract the JSON part after the last "success:"
          const parts = msg.split("success:");
          if (parts.length > 1) {
            return JSON.parse(parts[1]);
          }
        } catch (e) {
          return null;
        }
        return null;
      }

      // Check for the key
      const rawMsg = localStorage.getItem("cms_auth_token");

      if (rawMsg) {
        // Show status
        document.getElementById('status').style.display = 'block';

        // 1. Extract the Token
        const data = getJsonFromUrl(rawMsg);
        
        if (data && data.token) {
          console.log("Injecting Token...");

          // 2. Create the "Fake" User Object that Decap CMS expects
          const userObj = {
            "backendName": "github",
            "name": "Admin",
            "token": data.token
          };

          // 3. Save it where Decap CMS looks for it
          localStorage.setItem("netlify-cms-user", JSON.stringify(userObj));
          
          // 4. Clean up the mailbox so we don't do this forever
          localStorage.removeItem("cms_auth_token");

          // 5. Reload the page to let Decap see the new user
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        }
      }
    </script>

    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  </body>
</html>

